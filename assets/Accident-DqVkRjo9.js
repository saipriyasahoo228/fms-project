import{r as n,j as e}from"./index-K7U7e95_.js";import{D as re,C as ie,F as ce,A as de,a as me,b as ue,c as pe,I as he}from"./Imagecompression-Clw8wG7S.js";import{B as W,P as xe,I as L,j as N,v as je}from"./IconButton-DDU6yx0X.js";import{T as ye,a as fe,e as ge,c as G,d as x,b as be}from"./TableRow-B_hpd-CW.js";import{T as v,F as b,a as S}from"./TextField-YXPWbOlt.js";import{C as ve}from"./Container-DU-2yFqM.js";import{G as c,C as _e}from"./CircularProgress-CyhyCx0c.js";import{R as T,a as l}from"./RadioGroup-DAhucdu1.js";import{F as r}from"./FormControlLabel-B_AzigHb.js";import{B as Ce}from"./Button--os4TnKT.js";const A=({onEmployeesChange:j})=>{const[m,u]=n.useState([]),[_,I]=n.useState("cttc1234"),R=async t=>{try{return(await(await fetch("http://192.168.0.166:8000/employee/name/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee_id:t,whitelevel_id:_})})).json()).employee_name||""}catch(a){return console.error("Error fetching employee name:",a),""}};n.useEffect(()=>{j(m.map(t=>({employee:t.employee_id==="0"?"":t.employee_id,whitelevel_id:_,employee_id:t.employee_id==="0"?"":t.employee_id,employee_name:t.employee_id==="0"?t.name:t.employee_name,trainer_id:t.employee_id,trainer_name:t.employee_id==="0"?t.name:t.employee_name,trainee_id:t.employee_id==="0"?"":t.employee_id,trainee_name:t.employee_id==="0"?"":t.employee_name})))},[m,j]);const k=()=>{const t=m[m.length-1];if(t&&t.employee_id.trim()===""){alert("Please fill in the Employee ID for the last row before adding a new one.");return}u([...m,{employee_id:"",whitelevel_id:_,employee_name:"",error:!1,manual:!1}])},B=t=>{const a=m.filter((o,p)=>p!==t);u(a)},C=(t,a)=>{const{name:o,value:p}=a.target,i=[...m];if(i[t][o]=p,o==="employee_id")if(p==="0")i[t].employee_name="",i[t].manual=!0,i[t].error=!1;else{const w=i.some((f,D)=>f.employee_id===p&&D!==t);i[t].error=w,w||R(p).then(f=>{i[t].employee_name=f,i[t].manual=!1,u(i)})}else o==="name"?i[t].manual=!0:u(i)},P=async t=>{const{employee_id:a}=m[t],o=[...m];if(a==="0")o[t].manual=!0;else{if(a){const p=await R(a);o[t].employee_name=p}o[t].manual=!1}u(o)};return e.jsxs(W,{sx:{position:"relative"},children:[e.jsx(ye,{component:xe,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:e.jsxs(fe,{children:[e.jsx(ge,{children:e.jsxs(G,{children:[e.jsx(x,{children:"Sl. No"}),e.jsx(x,{children:"Employee ID"}),e.jsx(x,{children:"Employee Name"}),e.jsx(x,{children:"Actions"})]})}),e.jsx(be,{children:m.map((t,a)=>e.jsxs(G,{children:[e.jsx(x,{children:a+1}),e.jsx(x,{children:e.jsx(v,{variant:"outlined",size:"small",name:"employee_id",value:t.employee_id,onChange:o=>C(a,o),fullWidth:!0,error:t.error,helperText:t.error?"Duplicate employee ID":""})}),e.jsx(x,{children:e.jsx(v,{variant:"outlined",size:"small",name:t.employee_id==="0"?"name":"employee_name",value:t.employee_id==="0"?t.name:t.employee_name,onChange:o=>C(a,o),fullWidth:!0,disabled:!t.manual&&t.employee_id!=="0"})}),e.jsxs(x,{children:[e.jsx(L,{onClick:()=>B(a),children:e.jsx(re,{})}),e.jsx(L,{onClick:()=>P(a),children:e.jsx(ie,{})})]})]},a))})]})}),e.jsx(ce,{color:"primary","aria-label":"add",onClick:k,size:"small",sx:{position:"absolute",bottom:-18,left:"47%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:e.jsx(de,{})})]})},Ne=()=>{const[j,m]=n.useState("cttc1234"),[u,_]=n.useState(""),[I,R]=n.useState("false"),[k,B]=n.useState(""),[C,P]=n.useState(""),[t,a]=n.useState(""),[o,p]=n.useState(""),[i,w]=n.useState(""),[f,D]=n.useState(""),[J,H]=n.useState([]),[Y,$]=n.useState([]),[q,K]=n.useState([]),[F,M]=n.useState(""),[V,X]=n.useState(""),[Q,O]=n.useState(!1),U=s=>{M(s.target.value)},E=(s,g)=>{s==="supervisors"&&H(g),s==="workmen"&&$(g),s==="reported_by"&&K(g)},Z=s=>{_(s.target.value)},ee=s=>{R(s.target.value)},te=s=>{P(s.target.value)},se=s=>{a(s.target.value)},ae=s=>{p(s.target.value)},ne=s=>{w(s.target.value)},oe=s=>{D(s.target.value)},le=s=>{B(s.target.value)},z=async s=>{s.preventDefault(),O(!0);const g={accident_reporting_date:C,accident_id:t,accident_type:parseInt(u,10),severity:parseInt(o,10),permit_status:parseInt(i,10),ppe_status:parseInt(f,10),toolbox_train:I==="true",toolbox_reference_number:k,accident_image:V,about_the_accident:F,whitelevel:j,reported_by:q.map(({employee:d,employee_name:y,whitelevel_id:h})=>({employee:d,employee_name:y,whitelevel_id:h})),workmen:Y.map(({employee:d,employee_name:y,whitelevel_id:h})=>({employee:d,employee_name:y,whitelevel_id:h})),supervisors:J.map(({employee:d,employee_name:y,whitelevel_id:h})=>({employee:d,employee_name:y,whitelevel_id:h}))};console.log("Submitting the following data:"),console.log(JSON.stringify(g,null,2));try{const d=await fetch("http://192.168.0.166:8000/accident/create/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)});if(!d.ok){const h=await d.json();throw console.error("Error details:",h),new Error(`HTTP error! Status: ${d.status}. ${h.message}`)}const y=await d.json();console.log("Success:",y),window.alert("Form submitted successfully!")}catch(d){console.error("Error in handleSubmit:",d.message),window.alert("Error submitting form. Please try again.")}finally{O(!1)}};return e.jsxs(ve,{children:[e.jsx(W,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:e.jsx("form",{onSubmit:z,children:e.jsx(me,{sx:{width:"100%",maxWidth:1500,padding:3,boxShadow:3},children:e.jsxs(ue,{children:[e.jsxs(c,{container:!0,spacing:2,children:[e.jsx(c,{item:!0,xs:12,sm:6,children:e.jsx(v,{label:"Date",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},value:C,onChange:te})}),e.jsx(c,{item:!0,xs:12,sm:6,children:e.jsx(v,{label:"Reference Number",fullWidth:!0,onChange:se,value:t})})]}),e.jsx(pe,{sx:{marginY:3}}),e.jsxs(b,{component:"fieldset",margin:"normal",children:[e.jsx(S,{component:"legend",children:"Incident Type"}),e.jsxs(T,{row:!0,value:u,onChange:Z,children:[e.jsx(r,{value:"2",control:e.jsx(l,{}),label:"Accident"}),e.jsx(r,{value:"1",control:e.jsx(l,{}),label:"Near Miss"})]})]}),u&&e.jsxs(c,{container:!0,spacing:2,children:[e.jsxs(c,{item:!0,xs:12,children:[e.jsx(N,{gutterBottom:!0,children:"Reported By:"}),e.jsx(A,{onEmployeesChange:s=>E("reported_by",s),initialWhitelevelId:j})]}),e.jsxs(c,{item:!0,xs:12,children:[e.jsx(N,{gutterBottom:!0,children:"Workmen Involved:"}),e.jsx(A,{onEmployeesChange:s=>E("workmen",s),initialWhitelevelId:j})]}),e.jsxs(c,{item:!0,xs:12,children:[e.jsx(N,{gutterBottom:!0,children:"Supervisor:"}),e.jsx(A,{onEmployeesChange:s=>E("supervisors",s),initialWhitelevelId:j})]}),u==="2"&&e.jsxs(e.Fragment,{children:[e.jsx(c,{item:!0,xs:12,children:e.jsxs(b,{component:"fieldset",children:[e.jsx(S,{component:"legend",children:"Type Of Accident"}),e.jsxs(T,{row:!0,value:o,onChange:ae,children:[e.jsx(r,{value:"1",control:e.jsx(l,{}),label:"1"}),e.jsx(r,{value:"2",control:e.jsx(l,{}),label:"2"}),e.jsx(r,{value:"3",control:e.jsx(l,{}),label:"3"}),e.jsx(r,{value:"4",control:e.jsx(l,{}),label:"4"}),e.jsx(r,{value:"5",control:e.jsx(l,{}),label:"5"})]})]})}),e.jsx(c,{item:!0,xs:12,children:e.jsxs(b,{component:"fieldset",children:[e.jsx(S,{component:"legend",children:"Permit Status"}),e.jsxs(T,{row:!0,value:i,onChange:ne,children:[e.jsx(r,{value:"4",control:e.jsx(l,{}),label:"Valid"}),e.jsx(r,{value:"3",control:e.jsx(l,{}),label:"Not Required"}),e.jsx(r,{value:"2",control:e.jsx(l,{}),label:"No Permit"}),e.jsx(r,{value:"1",control:e.jsx(l,{}),label:"Expired"})]})]})}),e.jsx(c,{item:!0,xs:12,sm:6,children:e.jsxs(b,{component:"fieldset",children:[e.jsx(S,{component:"legend",children:"PPE Status"}),e.jsxs(T,{row:!0,value:f,onChange:oe,children:[e.jsx(r,{value:"2",control:e.jsx(l,{}),label:"OK"}),e.jsx(r,{value:"1",control:e.jsx(l,{}),label:"Faulty"})]})]})}),e.jsxs(c,{item:!0,xs:12,sm:6,children:[e.jsxs(b,{component:"fieldset",children:[e.jsx(S,{component:"legend",children:"Tool Box Talk"}),e.jsxs(T,{row:!0,value:I,onChange:ee,children:[e.jsx(r,{value:"true",control:e.jsx(l,{}),label:"Yes"}),e.jsx(r,{value:"false",control:e.jsx(l,{}),label:"No"})]})]}),I==="true"&&e.jsx(v,{label:"ToolBox Reference Number",fullWidth:!0,onChange:le,value:k,sx:{marginTop:2}})]}),e.jsx(c,{item:!0,xs:12,children:e.jsx(b,{fullWidth:!0,margin:"normal",children:e.jsx(v,{label:"About the Accident",multiline:!0,rows:4,value:F,onChange:U})})}),e.jsx(c,{item:!0,xs:12,children:e.jsx(he,{setCompressedImageBase64:X})})]})]}),e.jsx(W,{sx:{display:"flex",justifyContent:"center",marginTop:3},children:e.jsx(Ce,{variant:"contained",color:"primary",onClick:z,children:"Submit"})})]})})})}),e.jsx(je,{open:Q,sx:{color:"#fff",zIndex:s=>s.zIndex.drawer+1},children:e.jsx(_e,{color:"inherit"})})]})};export{Ne as default};
